{
  "name": "microblog",
  "version": 0.1,
  "imports": [
    "https://get.silverbullet.md/global.plug.json"
  ],
  "functions": {
    "publish": {
      "env": "server",
      "events": [
        "share:microblog"
      ],
      "code": "(() => { var mod=(()=>{var C=Object.create;var u=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var L=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var E=(e=>typeof require!=\"undefined\"?require:typeof Proxy!=\"undefined\"?new Proxy(e,{get:(r,t)=>(typeof require!=\"undefined\"?require:r)[t]}):e)(function(e){if(typeof require!=\"undefined\")return require.apply(this,arguments);throw new Error('Dynamic require of \"'+e+'\" is not supported')});var f=(e,r)=>{for(var t in r)u(e,t,{get:r[t],enumerable:!0})},T=(e,r,t,o)=>{if(r&&typeof r==\"object\"||typeof r==\"function\")for(let n of N(r))!O.call(e,n)&&n!==t&&u(e,n,{get:()=>r[n],enumerable:!(o=S(r,n))||o.enumerable});return e};var _=(e,r,t)=>(t=e!=null?C(L(e)):{},T(r||!e||!e.__esModule?u(t,\"default\",{value:e,enumerable:!0}):t,e)),$=e=>T(u({},\"__esModule\",{value:!0}),e);var te={};f(te,{default:()=>re});typeof self>\"u\"&&(self={syscall:()=>{throw new Error(\"Not implemented here\")}});var i=self.syscall;var a={};f(a,{parseMarkdown:()=>Y});function Y(e){return i(\"markdown.parseMarkdown\",e)}var c={};f(c,{deleteAttachment:()=>W,deletePage:()=>Q,getAttachmentMeta:()=>z,getPageMeta:()=>q,listAttachments:()=>j,listPages:()=>U,listPlugs:()=>V,readAttachment:()=>G,readPage:()=>D,writeAttachment:()=>H,writePage:()=>K});function U(e=!1){return i(\"space.listPages\",e)}function q(e){return i(\"space.getPageMeta\",e)}function D(e){return i(\"space.readPage\",e)}function K(e,r){return i(\"space.writePage\",e,r)}function Q(e){return i(\"space.deletePage\",e)}function V(){return i(\"space.listPlugs\")}function j(){return i(\"space.listAttachments\")}function z(e){return i(\"space.getAttachmentMeta\",e)}function G(e){return i(\"space.readAttachment\",e)}function H(e,r,t){return i(\"space.writeAttachment\",e,r,t)}function W(e){return i(\"space.deleteAttachment\",e)}function m(e,r){if(r(e))return[e];let t=[];if(e.children)for(let o of e.children)t=[...t,...m(o,r)];return t}function p(e,r){if(e.children){let t=e.children.slice();for(let o of t){let n=r(o);if(n!==void 0){let s=e.children.indexOf(o);n?e.children.splice(s,1,n):e.children.splice(s,1)}else p(o,r)}}}function l(e,r){return m(e,t=>t.type===r)[0]}function v(e,r){m(e,r)}function g(e){let r=[];if(e.text!==void 0)return e.text;for(let t of e.children)r.push(g(t));return r.join(\"\")}var P=_(E(\"https://deno.land/std/encoding/yaml.ts\"));async function b(e,r=[\"yaml\"]){let t=await c.readPage(e),o=await a.parseMarkdown(t),n={};return v(o,s=>{if(s.type!==\"FencedCode\")return!1;let x=l(s,\"CodeInfo\");if(!x||!r.includes(x.children[0].text))return!1;let h=l(s,\"CodeText\");if(!h)return!1;let A=h.children[0].text;try{n=P.parse(A)}catch(y){throw console.error(\"YAML Page parser error\",y),new Error(`YAML Error: ${y.message}`)}return!0}),n}async function w(e){try{let r=await b(\"SECRETS\",[\"yaml\",\"secrets\"]),t=[];for(let o of e){let n=r[o];if(n)t.push(n);else throw new Error(`No such secret: ${o}`)}return t}catch(r){throw r.message===\"Page not found\"?new Error(`No such secret: ${e[0]}`):r}}function X(e){return e.replaceAll(\" \",\"_\")}async function M(e,r){let t=await a.parseMarkdown(e);return p(t,o=>{if(o.type===\"WikiLink\"){let n=o.children[1].children[0].text;return r&&!r.includes(n)?{text:`_${n}_`}:{text:`[${n}](/${X(n)})`}}if(o.type===\"CommentBlock\"||o.type===\"Comment\"||o.type===\"NamedAnchor\")return null;if(o.type===\"Hashtag\")return{text:`__${o.children[0].text}__`};if(o.type===\"URL\"){let n=o.children[0].text;n.indexOf(\"://\")===-1&&(o.children[0].text=`fs/${n}`),console.log(\"Link\",n)}if(o.type===\"FencedCode\"){let n=l(o,\"CodeInfo\");if(!n)return;if(n.children[0].text===\"meta\")return null}}),g(t)}var d=new URL(\"https://micro.blog/micropub\"),Z=/^---\\n(?:.|.\\s)*\\n*---/;async function ee(e){let r=e.split(Z),[t,o]=r;return console.log(r),await M(o)}async function k(e){let r=await c.readPage(e.name),t=await ee(r),o=(await w([\"microblog\"]))[0].token;d.searchParams.append(\"h\",\"entry\"),d.searchParams.append(\"content\",t),console.log(d.toString());try{let n=await fetch(d.toString(),{method:\"POST\",headers:{Authorization:`Bearer ${o}`}});console.log(n.status,n.statusText)}catch(n){return console.error(n,\"fetch error\"),!1}return!0}var re=k;return $(te);})();\n return mod;})()"
    }
  },
  "assets": {}
}
